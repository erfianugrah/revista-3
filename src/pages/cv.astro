---
import BaseLayout from "../layouts/BaseLayout.astro";
import ThemeToggle from "../components/ThemeToggle";
import fs from "node:fs";
import path from "node:path";

// --------------- Read exported HTML ---------------

const htmlPath = path.join(process.cwd(), "src/content/cv/cv-export.html");
const rawHtml = fs.readFileSync(htmlPath, "utf-8");

// Extract all <style> blocks and strip rules that conflict with BaseLayout
const styleBlocks = [...rawHtml.matchAll(/<style>([\s\S]*?)<\/style>/g)]
  .map((m) => m[1])
  .join("\n")
  // Remove html/body/body>div rule blocks — BaseLayout owns page layout
  .replace(/\bhtml\s*\{[^}]*\}/g, "")
  .replace(/\bbody\s*\{[^}]*\}/g, "")
  .replace(/body\s*>\s*div\s*\{[^}]*\}/g, "")
  // Rescope "body > div" selectors to ".cv-imported" so they target
  // the CV content container instead of BaseLayout's body > div
  .replace(/body\s*>\s*div\b/g, ".cv-imported")
  // Remove .cv-preview-container hardcoded white bg (keep rest of the rule)
  .replace(/background-color:\s*white\s*!important;?/g, "")
  // Remove hardcoded body text color declarations
  .replace(/color:\s*rgb\(30,\s*30,\s*30\);?/g, "");

// Extract <body> inner content
const bodyMatch = rawHtml.match(/<body>([\s\S]*)<\/body>/);
const cvBody = bodyMatch?.[1]?.trim() ?? "";

// Page metadata
const pageTitle = "ERFI ANUGRAH | CV";
const description = "Photographer | Writer | Customer Solutions Engineer";
const site_name = "stoicopa";

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: "Erfi Anugrah",
  jobTitle: "Senior Customer Solutions Engineer",
  url: new URL(Astro.url.pathname, Astro.site).href,
  sameAs: [
    "https://github.com/erfianugrah",
    "https://linkedin.com/in/erfianugrah",
    "https://erfi.dev",
  ],
  workLocation: { "@type": "Place", name: "Cloudflare" },
  knowsAbout: ["Web Development", "Cloud Computing", "Network Security"],
};
---

<BaseLayout
  title={pageTitle}
  description={description}
  site_name={site_name}
  is404Page={false}
  hideHeaderFooter={true}
>
  <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />

  <!-- cv-v0 styles -->
  <Fragment set:html={`<style>${styleBlocks}</style>`} />

  <div class="max-w-4xl mx-auto shadow-[0_4px_24px_-4px_rgba(0,0,0,0.15)] dark:shadow-[0_4px_24px_-4px_rgba(0,0,0,0.5)] rounded-lg overflow-hidden print:shadow-none">
    <!-- Revista toolbar -->
    <div class="flex items-center justify-end gap-3 px-4 sm:px-8 py-3 text-gray-700 dark:text-[rgb(245,245,245)] print:hidden">
      <ThemeToggle client:load />
    </div>

    <!-- Imported CV content -->
    <div id="cv-content" class="cv-preview-container cv-imported p-4 sm:p-8">
      <Fragment set:html={cvBody} />
    </div>
  </div>
</BaseLayout>

<script>
  import { initTheme } from "../scripts/theme.ts";
  initTheme();
</script>

<style is:global>
  /* ── Light mode defaults ──
     We stripped `background-color: white !important` and `color: rgb(30,30,30)`
     from the cv-v0 CSS at build time so dark mode can override them. Re-apply
     them here, without !important, as the light-mode baseline. */
  .cv-imported {
    background-color: white;
    color: rgb(30, 30, 30);
  }

  /* ── Dark mode ──
     Target Tailwind utility classes directly (they're real class tokens on
     elements, e.g. class="text-gray-900 font-bold") rather than attribute
     substring selectors which were too greedy. */

  /* Container — slightly elevated from page bg so shadow has contrast */
  .dark .cv-imported {
    background-color: rgb(45, 44, 49) !important;
    color: #cbd5e1 !important; /* slate-300 fallback */
  }

  /* Primary text — headings, titles, skill labels (text-gray-900) */
  .dark .cv-imported .text-gray-900 {
    color: #f1f5f9 !important; /* slate-100 */
  }

  /* Body text — descriptions, achievements, bullets (text-gray-700) */
  .dark .cv-imported .text-gray-700 {
    color: #cbd5e1 !important; /* slate-300 */
  }

  /* Secondary text — school names, project language stats (text-gray-600) */
  .dark .cv-imported .text-gray-600 {
    color: #94a3b8 !important; /* slate-400 */
  }

  /* Muted text — dates, durations, "Key Achievements" label (text-gray-500) */
  .dark .cv-imported .text-gray-500 {
    color: #64748b !important; /* slate-500 */
  }

  /* Accent colors — brighten blues for dark background */
  .dark .cv-imported .text-blue-600 {
    color: #93c5fd !important; /* blue-300 */
  }
  .dark .cv-imported .text-blue-700 {
    color: #93c5fd !important; /* blue-300 — tech tags */
  }

  /* Border accents */
  .dark .cv-imported .border-blue-600 {
    border-color: #3b82f6 !important; /* blue-500 */
  }
  .dark .cv-imported .border-blue-200 {
    border-color: #475569 !important; /* slate-600 */
  }
  .dark .cv-imported .border-gray-300 {
    border-color: #475569 !important; /* slate-600 */
  }

  /* Progress bar & language bar tracks */
  .dark .cv-imported .bg-gray-200 {
    background-color: #334155 !important; /* slate-700 */
  }

  /* Tech tag backgrounds */
  .dark .cv-imported .bg-blue-50 {
    background-color: rgba(59, 130, 246, 0.15) !important;
  }

  /* Profile image — soften shadow in dark mode */
  .dark .cv-imported img.shadow-md {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4) !important;
  }

  /* SVGs inherit color from parent via currentColor — no override needed */

  /* ── Print ── */
  @media print {
    .cv-imported {
      padding: 0 !important;
      background-color: white !important;
      color: rgb(30, 30, 30) !important;
    }
  }
</style>
