---
import BaseLayout from "../layouts/BaseLayout.astro";
import GetRandomImage from "../components/GetRandomImage.astro";
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import type { CollectionName } from "../scripts/collections";

interface TagImages {
  large: (string | null)[];
  medium: (string | null)[];
  small: (string | null)[];
  alt: string[];
}

export interface Props {
  directory: CollectionName;
  title: string;
}

const { directory, title } = Astro.props;
const allContent = await getCollection(directory);
const tags = [...new Set(allContent.map((post) => post.data.tags).flat())];

// De-duplicate image optimization: process each unique src only once
const imageCache = new Map<string, { large: string | null; medium: string | null; small: string | null }>();

async function getOptimizedImages(src: string, alt: string) {
  if (imageCache.has(src)) return imageCache.get(src)!;
  const [largeImage, mediumImage, smallImage] = await Promise.all([
    getImage({ src, alt, width: 1920, height: 1080, decoding: "async", format: "avif", quality: 65 }),
    getImage({ src, alt, width: 1280, height: 720, decoding: "async", format: "avif", quality: 65 }),
    getImage({ src, alt, width: 854, height: 480, decoding: "async", format: "avif", quality: 65 }),
  ]);
  const result = {
    large: largeImage?.src ?? null,
    medium: mediumImage?.src ?? null,
    small: smallImage?.src ?? null,
  };
  imageCache.set(src, result);
  return result;
}

const imagesByTag: Record<string, TagImages> = {};
for (const post of allContent) {
  for (const tag of post.data.tags) {
    if (!imagesByTag[tag]) {
      imagesByTag[tag] = { large: [], medium: [], small: [], alt: [] };
    }
    if (post.data.image?.src) {
      const optimized = await getOptimizedImages(post.data.image.src, post.data.image.alt);
      imagesByTag[tag].large.push(optimized.large);
      imagesByTag[tag].medium.push(optimized.medium);
      imagesByTag[tag].small.push(optimized.small);
      imagesByTag[tag].alt.push(post.data.image.alt);
    }
  }
}

const imageSizes = {
  width: {
    large: 1920,
    medium: 1280,
    small: 854,
  },
  height: {
    large: 1080,
    medium: 720,
    small: 480,
  },
};
---

<BaseLayout title={title} is404Page={false}>
  <div>
    {
      tags.length === 1 ? (
        <div class="object-contain w-full h-full relative flex items-center justify-center font-overpass-mono">
          <GetRandomImage
            images={JSON.stringify(imagesByTag[tags[0]])}
            tag={tags[0]}
            url={`/${directory}/tags/${tags[0]}`}
            width={imageSizes.width}
            height={imageSizes.height}
          />
          <slot />
        </div>
      ) : (
        <div class="sm:grid sm:grid-cols-4 gap-4 space-y-4 sm:space-y-0 justify-center items-center font-overpass-mono">
          {tags.map((tag) => (
            <div class="col-span-1">
              <GetRandomImage
                images={JSON.stringify(imagesByTag[tag])}
                tag={tag}
                url={`/${directory}/tags/${tag}`}
                width={imageSizes.width}
                height={imageSizes.height}
              />
            </div>
          ))}
          <slot />
        </div>
      )
    }
  </div>
</BaseLayout>
